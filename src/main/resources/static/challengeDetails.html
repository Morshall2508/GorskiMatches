<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="bigiPadForChallengeHistory">
    <div class="navigationBar">
        <div id="homeButton">Home</div>
        <div id="accountPage">Account</div>
    </div>
    <div id="indexPadForChallengeHistory">
        <div id="table"></div>
        <i class="arrow left" onclick="window.location.href='/challengeHistory.html?';"></i>
    </div>
</div>

<script type="module">
        import Auth from "/auth.js";
        const urlParams = new URLSearchParams(window.location.search);
        const uuid = urlParams.get('uuid');
        sessionStorage.setItem('uuid', uuid);


        fetch(`/api/challenge/${uuid}`)
            .then(res => {
                if (res.ok) {
                    return res.json()
                }
                {
                    throw "Not found";
                }
            })

            .then(json => {
                let html = "";
                const timeUser2 = (json.nonRegisteredUserTimeSeconds / 1000).toFixed(2);
                const timeUser1 = (json.registeredUserTimeSeconds / 1000).toFixed(2);

                let totalScoreRegister = json.registeredUserScore;
                let totalScoreNonRegister = json.nonRegisteredUserScore;
                let totalResultUser1 = 0;
                let totalResultUser2 = 0;
                document.getElementById("table").style.gap = "2px";
                html += `
                <div class = "sidebarElement"> Quiz</div>
                <div class = "sidebarElement"> Your Answer</div>
                <div class = "sidebarElement"> Opponent Answer</div>
                <div class = "sidebarElement"> Your Time </div>
                <div class = "sidebarElement"> Opponent Time </div>`

                json.challengeQuizzes.forEach(innerItem => {
                    localStorage.setItem('emailUser2', innerItem.emailUser2);
                    localStorage.setItem('emailUser1', innerItem.emailUser1);
                    if (innerItem.scoreUser1 > 0) {
                        totalResultUser1++;
                    }

                    if (innerItem.scoreUser2 > 0) {
                        totalResultUser2++;
                    }

                    let timeRegisteredUser1 = (innerItem.timeUser1 / 1000).toFixed(2);
                    let timeRegisteredUser2 = (innerItem.timeUser2 / 1000).toFixed(2);

                    localStorage.setItem('timeRegisteredUser1', timeRegisteredUser1);
                    localStorage.setItem('timeRegisteredUser2', timeRegisteredUser2)
                    let resultUser1 = Boolean(innerItem.scoreUser1 > 0);
                    let resultUser2 = Boolean(innerItem.scoreUser2 > 0);

                    if (localStorage.getItem('emailUser2') != null) {
                        if (Auth.getEmail() == localStorage.getItem('emailUser2')) {
                            if (innerItem.timeUser1 === 0 || innerItem.timeUser2 === 0) {
                                html += `<div class = "tableElement">${innerItem.quiz}</div>
                        <div class = "tableElement"> ${innerItem.answerUser2}</div>
                        <div class = "tableElement"> ${innerItem.answerUser1}</div>
                        </div>`
                            } else {
                                html += `<div class = "tableElement">${innerItem.quiz}</div>
                        <div class = "tableElement" style = background-color:${resultUser2 ? "#54af54" : "#d54545"}> ${innerItem.answerUser2}</div>
                        <div class = "tableElement" style = background-color:${resultUser1 ? "#54af54" : "#d54545"}> ${innerItem.answerUser1}</div>
                        </div>`
                            }
                        } else {
                            if (innerItem.timeUser1 === 0 || innerItem.timeUser2 === 0) {
                                html += `<div class = "tableElement">${innerItem.quiz}</div>
                        <div class = "tableElement"> ${innerItem.answerUser1}</div>
                        <div class = "tableElement"> ${innerItem.answerUser2}</div>
                        </div>`
                            } else {
                                html += `<div class = "tableElement">${innerItem.quiz}</div>
                        <div class = "tableElement" style = background-color:${resultUser1 ? "#54af54" : "#d54545"}> ${innerItem.answerUser1}</div>
                        <div class = "tableElement" style = background-color:${resultUser2 ? "#54af54" : "#d54545"}> ${innerItem.answerUser2}</div>
                        </div>`
                            }
                        }

                    } else {
                        if (timeUser1 === 0 || timeUser2 === 0) {
                            html += `<div class = "tableElement">${innerItem.quiz}</div>
                        <div class = "tableElement"> ${innerItem.answerUser2}</div>
                        <div class = "tableElement"> ${innerItem.answerUser1}</div>
                        </div>`
                        } else {
                            html += `<div class = "tableElement">${innerItem.quiz}</div>
                        <div class = "tableElement" style = background-color:${resultUser2 ? "#54af54" : "#d54545"}> ${innerItem.answerUser2}</div>
                        <div class = "tableElement" style = background-color:${resultUser1 ? "#54af54" : "#d54545"}> ${innerItem.answerUser1}</div>
                        </div>`
                        }
                    }
                })

                if (Auth.getEmail() == localStorage.getItem('emailUser1')) {
                    if (localStorage.getItem('emailUser2') == "null") {
                        if (parseFloat(localStorage.getItem('timeRegisteredUser1')) == 0 || parseFloat(localStorage.getItem('timeRegisteredUser2')) == 0) {
                            html += `<div class = "tableTime">${localStorage.getItem('timeRegisteredUser1')}s</div>
                         <div class = "tableTime">${localStorage.getItem('timeRegisteredUser2')}s</div>`

                        } else {
                            if (totalResultUser1 === totalResultUser2) {
                                let timeCompare = Boolean(parseFloat(localStorage.getItem('timeRegisteredUser2')) > parseFloat(localStorage.getItem('timeRegisteredUser1')));
                                html += `<div class = "tableTime" style = background-color:${timeCompare ? "#54af54" : "#d54545"}>${localStorage.getItem('timeRegisteredUser1')}s</div>
                         <div class = "tableTime" style = background-color:${timeCompare ? "#d54545" : "#54af54"}>${localStorage.getItem('timeRegisteredUser2')}s</div>`
                                document.getElementById("table").innerHTML = html;
                            } else {

                                html += `<div class = "tableTime">${localStorage.getItem('timeRegisteredUser1')}s</div>
                         <div class = "tableTime">${localStorage.getItem('timeRegisteredUser2')}s</div>`
                                document.getElementById("table").innerHTML = html;
                            }
                        }
                    }

                    else {
                        if (localStorage.getItem('timeRegisteredUser1') == 0 || localStorage.getItem('timeRegisteredUser2') == 0) {
                            html += `<div class = "tableTime">${localStorage.getItem('timeRegisteredUser1')}s</div>
                         <div class = "tableTime">${localStorage.getItem('timeRegisteredUser2')}s</div>`

                        } else {
                            if (totalResultUser1 === totalResultUser2) {
                                let timeCompare = Boolean(parseFloat(localStorage.getItem('timeRegisteredUser2')) > parseFloat(localStorage.getItem('timeRegisteredUser1')));
                                html += `<div class = "tableTime" style = background-color:${timeCompare ? "#54af54" : "#d54545"}>${localStorage.getItem('timeRegisteredUser1')}s</div>
                         <div class = "tableTime" style = background-color:${timeCompare ? "#d54545" : "#54af54"}>${localStorage.getItem('timeRegisteredUser2')}s</div>`
                                document.getElementById("table").innerHTML = html;
                            } else {

                                html += `<div class = "tableTime">${localStorage.getItem('timeRegisteredUser1')}s</div>
                         <div class = "tableTime">${localStorage.getItem('timeRegisteredUser2')}s</div>`
                                document.getElementById("table").innerHTML = html;
                            }
                        }
                    }
                } else {

                    if (parseFloat(localStorage.getItem('timeRegisteredUser1')) === 0 || parseFloat(localStorage.getItem('timeRegisteredUser2')) === 0) {
                        html += `<div class = "tableTime">${localStorage.getItem('timeRegisteredUser2')}s</div>
                         <div class = "tableTime">${localStorage.getItem('timeRegisteredUser1')}s</div>`

                    } else {
                        if (totalResultUser1 === totalResultUser2) {
                            let timeCompare = Boolean(parseFloat(localStorage.getItem('timeRegisteredUser1')) > parseFloat(localStorage.getItem('timeRegisteredUser2')));

                            html += `<div class = "tableTime" style = background-color:${timeCompare ? "#54af54" : "#d54545"}>${localStorage.getItem('timeRegisteredUser2')}s</div>
                         <div class = "tableTime" style = background-color:${timeCompare ? "#d54545" : "#54af54"}>${localStorage.getItem('timeRegisteredUser1')}s</div>`
                            document.getElementById("table").innerHTML = html;

                        } else {
                            html += `<div class = "tableTime">${localStorage.getItem('timeRegisteredUser2')}s</div>
                         <div class = "tableTime">${localStorage.getItem('timeRegisteredUser1')}s</div>`
                            document.getElementById("table").innerHTML = html;
                        }
                    }
                }
                document.getElementById("table").innerHTML = html;
            })

    </script>
<script>
        document.getElementById("accountPage").onclick = () => {
            window.location.replace("/account.html?")
        };
    </script>
<script>
        document.getElementById("homeButton").onclick = () => {
            window.location.replace("/")
        };
    </script>
</body>

</html>