<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="bigiPad">
    <div class="navigationBar">
        <div id="homeButton">Home</div>
        <div id="accountPage">Account</div>
    </div>
    <div id="equationPad">
        <p id="text">You've been challenged to solve the quizzes. Your goal is to move one match inside equation - you
            have 30
            seconds.There are 5 quizzes. You get 1 point for correct answer and 0 if you run out of time or give
            incorrect
            answer</p>
        <button id="buttonStart">Start!</button>
        <p id="countdownTimer"></p>
        <img id="image">
        <div id="quiz"></div>
        <div id="done"></div>
        <input id="answer">
        <button id="buttonCheck">Check!</button>
        <div id="solution"></div>
        <div id="allDone"></div>
        <div id="result"></div>
    </div>
</div>

</body>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const uuid = urlParams.get('uuid');
    sessionStorage.setItem('uuid', uuid);
</script>

<script type="module">
    import Auth from "/auth.js";


    document.getElementById("buttonStart").onclick = () => {
        fetch(`api/challenge/quizzes/${uuid}`)
            .then(res => res.json()
                .then(fiveQuizzes => {

                    const timeOnStart = performance.now();
                    console.log(fiveQuizzes);
                    var fiveQuizzes1 = fiveQuizzes.join();
                    console.log(fiveQuizzes1);
                    image.src = `/api/image/equation/${fiveQuizzes[0]}`;
                    sessionStorage.setItem('fiveQuizzes', fiveQuizzes);

                    var score = 0;

                    let index = 0;

                    var quiz = fiveQuizzes[index];
                    console.log(quiz);

                    let timeLeft = 30;
                    const element = document.getElementById('countdownTimer');
                    const timerId = setInterval(countdown, 1000);

                    function countdown() {
                        if (timeLeft === -1) {
                            clearTimeout(timerId);
                            element.innerHTML = "Time's up";

                        } else {
                            element.innerHTML = timeLeft + 's remaining';
                            timeLeft--;
                        }
                    }

                    document.getElementById("buttonCheck").onclick = () => {

                        timeLeft = 30;
                        fetch("/api/equation/solution",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    answer: document.getElementById("answer").value,
                                    quiz: quiz,
                                })
                            })
                            .then(res => res.json())
                            .then(text => {
                                document.getElementById("solution").innerText = text;
                                console.log(text);
                                if (text === true) {
                                    score++;
                                    console.log(score);
                                    sessionStorage.setItem('score', score.toString());
                                }
                                console.log(score);
                            });
                        image.src = `/api/image/equation/${fiveQuizzes[++index]}`;
                        quiz = fiveQuizzes[index];
                        console.log(quiz);
                        if (index === 5) {
                            image.src = null;
                            document.getElementById("done").innerText = "All done :)";
                            document.getElementById("text").style.display = "none";
                            document.getElementById("buttonStart").style.display = "none";
                            document.getElementById("countdownTimer").style.display = "none";
                            document.getElementById("buttonCheck").style.display = "none";
                            document.getElementById("solution").style.display = "none";
                            document.getElementById("answer").style.display = "none";
                            const timeOnEnd = performance.now();
                            let totalTimeToSolve = (+timeOnEnd) - (+timeOnStart);
                            if (Auth.isLoggedIn()) {
                                fetch("/api/challenge/score",
                                    {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            uuid: sessionStorage.getItem('uuid'),
                                            email: Auth.getEmail(),
                                            registeredUserScore: sessionStorage.getItem('score'),
                                            registeredUserTime: totalTimeToSolve
                                        })
                                    })
                                fetch(`/api/challenge/resultForRegisteredUser/${uuid}`)

                            } else {
                                fetch("/api/challenge/score",
                                    {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            uuid: sessionStorage.getItem('uuid'),
                                            nonRegisteredUserScore: sessionStorage.getItem('score'),
                                            nonRegisteredUserTime: totalTimeToSolve
                                        })
                                    })
                                fetch(`api/challenge/resultForNonRegistered/${uuid}`)
                                    .then(res => res.text())
                                    .then(text => {
                                        console.log(text);
                                        document.getElementById("result").innerText = text;
                                    });
                            }
                        }
                    };
                })
            );
    }
</script>

<script>
    document.getElementById("accountPage").onclick = () => {
        window.location.replace("/account.html?")
    };
</script>
<script>
    document.getElementById("homeButton").onclick = () => {
        window.location.replace("/")
    };
</script>

</html>